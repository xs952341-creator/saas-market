<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Publicar Micro-SaaS — SaaSMarket</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>

<body class="bg-slate-900 text-white antialiased">
<nav class="bg-slate-800/50 backdrop-blur-lg border-b border-white/10">
  <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
    <a href="hub.html" class="flex items-center gap-3"><div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg"></div><span class="font-black text-lg">SaaS<span class="text-indigo-400">Market</span></span></a>
    <a href="hub.html" class="text-sm text-slate-400 hover:text-white">← Voltar ao Hub</a>
  </div>
</nav>

<div class="bg-gradient-to-br from-purple-600/20 to-pink-600/20 backdrop-blur-lg border-b border-white/10 py-16">
  <div class="max-w-4xl mx-auto px-6">
    <h1 class="text-5xl font-black mb-4">Publique seu <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">Micro-SaaS</span></h1>
    <p class="text-xl text-slate-300">Monetize suas APIs e automações. Receba em tempo real por cada uso.</p>
  </div>
</div>

<div class="max-w-4xl mx-auto px-6 py-12">
  <form id="form-publicar" class="space-y-10">
    <div class="bg-slate-800 border border-white/10 rounded-2xl p-8">
      <h2 class="text-2xl font-black mb-6">Informações Básicas</h2>
      <div class="space-y-6">
        <div><label class="block text-sm font-semibold mb-2">Nome do Micro-SaaS *</label><input type="text" id="nome" required placeholder="Ex: Gerador de Avatares IA" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"/></div>
        <div><label class="block text-sm font-semibold mb-2">Categoria *</label><select id="categoria" required class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><option value="">Selecione...</option><option value="IA">Inteligência Artificial</option><option value="Automação">Automação</option><option value="Dados">Processamento de Dados</option><option value="Comunicação">Comunicação</option><option value="Marketing">Marketing</option><option value="Financeiro">Financeiro</option></select></div>
        <div><label class="block text-sm font-semibold mb-2">Descrição Curta *</label><textarea id="descricao" required rows="3" placeholder="Descrição que aparece nos cards (máx. 150 caracteres)" maxlength="150" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea></div>
        <div><label class="block text-sm font-semibold mb-2">Descrição Completa</label><textarea id="descricao-longa" rows="8" placeholder="Detalhes sobre funcionalidades, casos de uso, benefícios..." class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea></div>
      </div>
    </div>

    <div class="bg-slate-800 border border-white/10 rounded-2xl p-8">
      <h2 class="text-2xl font-black mb-6">Configuração Técnica</h2>
      <div class="space-y-6">
        <div><label class="block text-sm font-semibold mb-2">URL da API *</label><input type="url" id="api-url" required placeholder="https://api.seumicrosass.com/v1/endpoint" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"/><p class="text-xs text-slate-400 mt-2">A URL da sua API que será chamada quando um cliente usar o serviço</p></div>
        <div class="grid md:grid-cols-2 gap-6">
          <div><label class="block text-sm font-semibold mb-2">Método HTTP</label><select id="metodo-http" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><option value="POST">POST</option><option value="GET">GET</option><option value="PUT">PUT</option></select></div>
          <div><label class="block text-sm font-semibold mb-2"><input type="checkbox" id="sandbox-disponivel" class="mr-2"/>Disponibilizar Sandbox (Teste Grátis)</label><p class="text-xs text-slate-400 mt-2">Permite que compradores testem antes de usar</p></div>
        </div>
      </div>
    </div>

    <div class="bg-slate-800 border border-white/10 rounded-2xl p-8">
      <h2 class="text-2xl font-black mb-6">Modelo de Cobrança</h2>
      <div class="space-y-6">
        <div><label class="block text-sm font-semibold mb-2">Tipo de Cobrança *</label><select id="tipo-cobranca" required onchange="toggleModeloCobranca()" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><option value="pay-per-use">Pay-per-Use (Pague pelo que usar)</option><option value="assinatura">Assinatura Mensal</option></select></div>

        <div id="config-pay-per-use">
          <div class="grid md:grid-cols-2 gap-6">
            <div><label class="block text-sm font-semibold mb-2">Preço por Uso *</label><input type="number" id="preco-por-uso" step="0.0001" min="0.0001" placeholder="0.0100" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"/><p class="text-xs text-slate-400 mt-2">Quanto você cobra por cada execução/requisição</p></div>
            <div><label class="block text-sm font-semibold mb-2">Unidade de Cobrança *</label><select id="unidade-cobranca" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"><option value="requisicao">Por Requisição</option><option value="processamento">Por Processamento</option><option value="minuto">Por Minuto</option><option value="uso">Por Uso</option></select></div>
          </div>
          <div class="mt-4 p-4 bg-purple-500/10 border border-purple-500/30 rounded-xl"><p class="text-sm text-purple-300"><strong>Exemplo:</strong> Se você cobrar R$ 0,01 por requisição e um cliente fizer 1.000 requisições, você receberá R$ 10,00.</p></div>
        </div>

        <div id="config-assinatura" class="hidden">
          <div><label class="block text-sm font-semibold mb-2">Preço Mensal (R$) *</label><input type="number" id="preco-mensal" step="0.01" min="1" placeholder="47.00" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"/></div>
          <div class="mt-4"><label class="block text-sm font-semibold mb-2">Stripe Price ID *</label><input type="text" id="stripe-price-id" placeholder="price_1SzjiVE3IKoGtVrQtt5GGccz" class="w-full px-4 py-3 bg-slate-900 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"/><p class="text-xs text-slate-400 mt-2">ID do produto recorrente criado na Stripe</p></div>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between pt-8 border-t border-white/10">
      <a href="hub.html" class="text-slate-400 hover:text-white">← Cancelar</a>
      <button type="submit" id="btn-publicar" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-12 py-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-pink-700 transition">Publicar Micro-SaaS</button>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<script>
let userAtual = null;

async function init() {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = 'dashboard.html';
      return;
    }

    userAtual = session.user;
    toggleModeloCobranca();
  } catch (error) {
    console.error(error);
    alert('Erro ao iniciar página de publicação.');
  }
}

function toggleModeloCobranca() {
  const tipo = document.getElementById('tipo-cobranca').value;
  const pay = document.getElementById('config-pay-per-use');
  const ass = document.getElementById('config-assinatura');
  const precoUso = document.getElementById('preco-por-uso');
  const precoMensal = document.getElementById('preco-mensal');
  const stripePriceId = document.getElementById('stripe-price-id');

  if (tipo === 'pay-per-use') {
    pay.classList.remove('hidden');
    ass.classList.add('hidden');
    precoUso.required = true;
    precoMensal.required = false;
    stripePriceId.required = false;
  } else {
    pay.classList.add('hidden');
    ass.classList.remove('hidden');
    precoUso.required = false;
    precoMensal.required = true;
    stripePriceId.required = true;
  }
}

document.getElementById('form-publicar').onsubmit = async (e) => {
  e.preventDefault();

  const btn = document.getElementById('btn-publicar');
  btn.disabled = true;
  btn.textContent = 'Publicando...';

  try {
    const tipoCobranca = document.getElementById('tipo-cobranca').value;
    const dados = {
      seller_id: userAtual.id,
      nome: document.getElementById('nome').value,
      categoria: document.getElementById('categoria').value,
      descricao: document.getElementById('descricao').value,
      descricao_longa: document.getElementById('descricao-longa').value,
      api_url: document.getElementById('api-url').value,
      sandbox_disponivel: document.getElementById('sandbox-disponivel').checked,
      tipo_cobranca: tipoCobranca,
      ativo: true,
      verificado: false,
      taxa_sucesso: 100.00,
      total_execucoes: 0
    };

    if (tipoCobranca === 'pay-per-use') {
      dados.preco_por_uso = Number(document.getElementById('preco-por-uso').value);
      dados.unidade_cobranca = document.getElementById('unidade-cobranca').value;
      dados.preco = 0;
      dados.stripe_price_id = 'pay_per_use';
      dados.stripe_product_id = 'pay_per_use';
    } else {
      dados.preco = Number(document.getElementById('preco-mensal').value);
      dados.stripe_price_id = document.getElementById('stripe-price-id').value;
      dados.stripe_product_id = 'micro_saas_assinatura';
      dados.preco_por_uso = 0;
      dados.unidade_cobranca = null;
    }

    const { error } = await supabase.from('produtos').insert(dados);
    if (error) throw error;

    alert('✅ Micro-SaaS publicado com sucesso!\n\nEle está aguardando aprovação e em breve estará disponível no marketplace.');
    window.location.href = 'hub.html';
  } catch (error) {
    console.error(error);
    alert(`Erro ao publicar: ${error.message}`);
    btn.disabled = false;
    btn.textContent = 'Publicar Micro-SaaS';
  }
};

window.onload = init;
</script>

</body>
</html>
